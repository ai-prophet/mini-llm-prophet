name: Live API Gate

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  live-api-gate:
    name: live-api-gate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Determine gate mode
        id: mode
        env:
          LABELS_JSON: ${{ toJson(github.event.pull_request.labels.*.name) }}
        run: |
          if echo "$LABELS_JSON" | grep -q '"live-api-required"'; then
            echo "run_live=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_live=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Gate is inactive
        if: steps.mode.outputs.run_live != 'true'
        run: echo "live-api-required label not present; skipping live API tests."

      - name: Checkout PR head
        if: steps.mode.outputs.run_live == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Python
        if: steps.mode.outputs.run_live == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        if: steps.mode.outputs.run_live == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Validate live-test secrets
        if: steps.mode.outputs.run_live == 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          MINIPROPHET_TEST_OPENROUTER_MODEL: ${{ secrets.MINIPROPHET_TEST_OPENROUTER_MODEL }}
        run: |
          [ -n "$OPENROUTER_API_KEY" ] || { echo "Missing secret OPENROUTER_API_KEY"; exit 1; }
          [ -n "$MINIPROPHET_TEST_OPENROUTER_MODEL" ] || { echo "Missing secret MINIPROPHET_TEST_OPENROUTER_MODEL"; exit 1; }

      - name: Run live API tests
        if: steps.mode.outputs.run_live == 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          MINIPROPHET_TEST_OPENROUTER_MODEL: ${{ secrets.MINIPROPHET_TEST_OPENROUTER_MODEL }}
        run: python -m pytest -q -m live_api --run-live-api
