name: Live API Gate

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled, unlabeled]
  workflow_dispatch:
    inputs:
      pr_number:
        description: Pull request number to test
        required: true
        type: string
      force_run:
        description: Force live API test run even without label
        required: false
        default: "false"
        type: string

jobs:
  live-api-gate:
    name: live-api-gate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Resolve PR context and gate mode
        id: mode
        uses: actions/github-script@v7
        with:
          script: |
            const forceRun = (context.payload.inputs?.force_run || "false") === "true";
            let pr;
            if (context.eventName === "workflow_dispatch") {
              const prNumber = Number(context.payload.inputs?.pr_number || 0);
              if (!prNumber) {
                core.setFailed("workflow_dispatch requires a valid pr_number input");
                return;
              }
              const { data } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });
              pr = data;
            } else {
              pr = context.payload.pull_request;
            }

            const labels = (pr.labels || []).map((l) => l.name);
            const hasLabel = labels.includes("live-api-required");
            const runLive = forceRun || hasLabel;

            core.setOutput("run_live", runLive ? "true" : "false");
            core.setOutput("head_repo", pr.head.repo.full_name);
            core.setOutput("head_sha", pr.head.sha);
            core.setOutput("pr_number", String(pr.number));

      - name: Gate is inactive
        if: steps.mode.outputs.run_live != 'true'
        run: echo "live-api-required label not present; skipping live API tests."

      - name: Checkout PR head
        if: steps.mode.outputs.run_live == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.mode.outputs.head_repo }}
          ref: ${{ steps.mode.outputs.head_sha }}

      - name: Setup Python
        if: steps.mode.outputs.run_live == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        if: steps.mode.outputs.run_live == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Validate live-test secrets
        if: steps.mode.outputs.run_live == 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          MINIPROPHET_TEST_OPENROUTER_MODEL: ${{ secrets.MINIPROPHET_TEST_OPENROUTER_MODEL }}
        run: |
          [ -n "$OPENROUTER_API_KEY" ] || { echo "Missing secret OPENROUTER_API_KEY"; exit 1; }
          [ -n "$MINIPROPHET_TEST_OPENROUTER_MODEL" ] || { echo "Missing secret MINIPROPHET_TEST_OPENROUTER_MODEL"; exit 1; }

      - name: Run live API tests
        if: steps.mode.outputs.run_live == 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          MINIPROPHET_TEST_OPENROUTER_MODEL: ${{ secrets.MINIPROPHET_TEST_OPENROUTER_MODEL }}
        run: python -m pytest -q -m live_api --run-live-api
